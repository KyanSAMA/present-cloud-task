# 9 数据库设计规范和数据库建模

## 9.1 任务描述

### 9.1.1 任务介绍

使用Powerdesiger软件设计并创建数据库。

### 9.1.2 任务要求

- 创建物理数据模型并创建相关的表
  - 数据字典
  - 权限（菜单）
  - 角色
  - 角色权限
  - 用户，能够使用多种账号登录
- 使用PowerDesigner软件生成数据库
- 继续完成后台管理系统的相关界面
  - 登录页面
  - 忘记密码页面
  - 403异常页面
  - 404异常页面
  - 500异常页面
  - 自定义异常页面

## 9.2 工作指导说明

### 9.2.1 数据库设计开发规范

### 9.2.1.1 命名规范

入乡随俗，不同的数据库使用的命名规范存在着不同。以下数据库对象命名的案例依照的是微软的SQL Server数据库的命名规范。
Pascal Case，如AdventureWork；每一个单词的第一个字母大写。
表名使用单数名；
所有表示时间的字段，统一以 Date 来作为结尾（而不是有的使用Date,有的使用Time）
采用英文单词或英文短语（包括缩写）作为名称，不能使用无意义的字符或汉语拼音。

数据库对象 |命名规范 | 说明
---|---|---
存储过程 | [SP_]+[表名]+[操作名字] | SP_Community_Update
视图 | V_[表名]..[表名]+[描述]
主键 | PK_[表名] | PK_Community
外键 | FK_[主表名]+[从表名]+[字段名] | FK_Hotel_City_Cityid
触发器 | TR_[表名]+[ _I、_U、_D]+[字段\描述] | TR ，
default | DF_[表名]_[列名] | DF _Community_Age
CHECK | CK_[表名]_[列名] | CK_Community_Number
UNIQUE | UQ_[表名]_[列名] | UQ_Community_Name
索引 | IDX_[表名]_[列名] |

[操作名字]：
[Insert|Delete|Update|Calculate|Confirm]  
在实际开发中，由于数据库本质就是I/O的处理，再加上额外的约束的检出，会拖慢数据库执行的效率。因此像default、check等约束基本上不去设定。相关的数据有效性检查，交给展示层或者客户端以及服务器端通过程序层面来实现。甚至外键约束也不使用，也是在程序层面实现。当然，在数据库创建了约束并不意味着在程序层面就不用实现了，这些数据的有效性验证在程序中还是要处理的。

### 9.2.1.2 设计规范

每张表的第一个字段是Id用于表示记录的编号，设置成主键及Identity自动增长。这个数据不是用来描述员工的工号、订单的编号、入库单的编号等数据，仅仅用于数据的维护。例如，根据Id删除数据、查询数据等操作，
每张表的最后都增加4个字段，用于记录该笔数据的创建时间，创建人，最后修改人，最后修改时间。

名字 | 字段 | 说明
---|---|---
记录编号 | Id
创建时间 | CreationDate
创建者 | Creator | UserID 不需要外键关联
最后一次修改时间 | ModificationDate
最后一次修改者 | Modifier | UserID 不需要外键关联

如果用户要求显示创建者和修改者，就需要创建外键关联。  
如果有实现软删除，建议统一使用下面的字段：
名字 | 字段 | 说明
---|---|---
删除者 | Deleter | UserID 不需要外键关联
删除时间 | DeletionDate
是否删除 | IsDeleted

在实际的工作中，项目已经处于生产模式，客户提出要为某个实体增加一些属性。这种情况下需要修改界面，服务器端代码，还要改数据库，所有层的相关代码基本都要改，难受！难受！  
在实际中能不能少修改些？早期比较笨的办法在一些表中事先增加部分额外的字段：value1、value2、value3等。这样在生产模式下至少数据库、实体、数据访问层相关代码不用修改。现在你可以参考上学期任务中LocalStorage的做法，把额外增加的属性的名称和值，转换成JSON格式的字符串，数据库的表中只需要一个字段ExtendJSON就能够额外存储多个属性。

#### 9.2.1.3 SQL开发规范

ORM

### 9.2.2 数据库建模

概念数据模型用于数据库概念结构设计阶段，用E-R图描述实体以及实体之间的联系。主要包括实体、实体属性、联系等对象。物理数据模型则是在概念数据模型（或逻辑数据模型）基础上采用图形的方式描述数据的物理组织，并最终在数据库管理系统中实现该模型。物理数据模型（Physical Data Model，PDM）描述了数据在存储介质上的组织结构，与具体数据库管理系统(DataBase Management System, DBMS) 有关。

#### 9.2.2.1 PowerDesigner基础用法

1. 使用PowerDesigner软件创建物理数据模型。

2. 定义表

3. 定义列（字段）

4. 复制列

5. 定义主键

6. 定义外键

7. 定义索引

8. 使用PDM生成脚本

#### 9.2.2.2 为到云数据库设计PDM

**按钮类别Button**  
Button表用于保存所有的按钮类型，本质是所有页面用到的操作类型，这张表可以不用添加创建时间等4个字段。如果没有实现按钮级别的权限控制，不需要这张表。
字段 | 说明
---|---
按钮类型 | 说明按钮的用途，例如：删除、修改、打印等
按钮类型英文标识 | btnSave、btnDelete等，在界面使用时，作为参数传递给组件类。实际上这张表的数据也可以保存在字典表中。
如果有实现按钮级别的权限控制，建议创建下面这几张表：  
菜单表，保存菜单项。  
页面按钮表，保存页面中有哪些按钮需要设置权限。还有一种做法，页面按钮表保存页面上那些需要控制权限按钮的唯一标识。  
角色权限表，保存角色拥有的权限和权限的类型。  
~~权限表，权限类型（菜单、按钮等），每条记录代表一项权限。~~  
~~菜单权限表，权限表和菜单表的关联表。~~  
~~页面按钮权限表，权限表和页面按钮表的关联表。~~  

**权限Permission**  
权限这张表实际上就是菜单表。当然也不纯粹是每一个菜单项，也包括了没有出现在菜单中的页面。像商品的类别、公司上下级部门、行政区域等类似的树形结构，在设计表时添加ParentId字段，用于描述某一节点的父节点。ParentId字段是设置成外键，引用了自己表中的Id主键。这里的ParentId指的是上级菜单项的编号。

**字典Dictionary**  
这张表可以不要添加创建时间等4个字段。

**字典明细DictionaryDetail**  
在字典主表中有个字段Code主要用途是为前端开发人员向服务器请求某组数据时传递参数提供的值。服务器端的代码从数据库获取相关数据时，使用类似下面的SQL：

```sql
select ItemKey, ItemValue, IsDefault from DictionaryDetail dd inner join Dictionary d on d.Id = dd.DictionaryId where d.Code = "参数的值" order by sort
```

虽然会在Code字段上创建一个唯一值索引，提高查询的效率。但是，查询语句关联了两张表，降低了查询效率。我们发现Code字段是为开发人员服务的，正常情况下值是不会发生变化的。为了提高查询效率，可以使用适当的冗余，在DictionaryDetail表中增加一个相同的字段Code。这样SQL语句就可以改为：

```sql
select ItemKey, ItemValue, IsDefault from DictionaryDetail where Code = "参数的值" order by sort
```

为了提高查询效率，为DictionaryDetail表的Code字段创建一个普通索引。  
类似在商品表中商品的名称基本上较少出现改动的情况，订单明细表中正常只有ProductId字段，界面上展示时又需要显示商品的名称，可以使用上面的方法查询时减少表之间的关联。

**角色Role**
角色表作为用户表和角色权限表的主表。

**角色权限RolePermission**
为每一个角色分配菜单项。

**用户User**
设计时应考虑用户登录时可以使用多种方式登录，包括第三方登录，例如微信授权登录。

**用户角色UserRole**  
一个用户可以拥有多种角色，一个角色也会属于多个用户，因此用户和角色之间构成多对多的关系。  

## 9.3 产品要求

无

## 9.4 工作要求

无
